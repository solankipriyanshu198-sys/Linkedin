{% extends 'jobportal/base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'jobportal/css/job_detail.css' %}">
<link rel="stylesheet" href="{% static 'jobportal/css/model.css' %}">

<div class="job-container">
    
    <div class="content-wrapper">
        
       <div class="card job-header">
            <div style="margin-bottom: 15px;">
                <a href="{% url 'company_profile' job.company.id %}" style="text-decoration: none;">
                    {% if job.company.logo %}
                        <img src="{{ job.company.logo.url }}" alt="{{ job.company.company_name }}" style="width: 60px; height: 60px; border-radius: 12px; object-fit: contain; background: white; border: 1px solid #f3f4f6; padding: 2px;">
                    {% else %}
                        <div style="width: 60px; height: 60px; border-radius: 12px; background: #f3f4f6; color: #374151; font-size: 1.5rem; font-weight: bold; display: flex; align-items: center; justify-content: center;">
                            {{ job.company.company_name|slice:":1" }}
                        </div>
                    {% endif %}
                </a>
            </div>
            
            <h1>{{ job.title }}</h1>
            
            <div class="company-row">
                <a href="{% url 'company_profile' job.company.id %}" style="font-weight: 600; color: var(--primary); text-decoration: none;">
                    {{ job.company.company_name }}
                </a>
                
                <span style="color: #9ca3af; margin: 0 5px;">‚Ä¢</span>
                <span style="color: #6b7280;">{{ job.location }}</span>
                <span style="color: #9ca3af; margin: 0 5px;">‚Ä¢</span>
                <span style="color: #6b7280;">{{ job.job_type }}</span>
            </div>
        </div>

        <div class="card job-description">
            <h2>About the job</h2>
            <p>{{ job.description|linebreaks }}</p>

            <h2>Requirements</h2>
            <ul>
                {% for req in job.get_requirements_list %}
                    {% if req.strip %}
                        <li>{{ req }}</li>
                    {% endif %}
                {% empty %}
                     <li>No specific requirements listed.</li>
                {% endfor %}
            </ul>

            <h2>Benefits</h2>
            <ul>
                {% for benefit in job.get_benefits_list %}
                    {% if benefit.strip %}
                        <li>{{ benefit }}</li>
                    {% endif %}
                {% empty %}
                     <li>No specific benefits listed.</li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <div class="sidebar-wrapper">
     <div class="card action-card">
            
            <div style="margin-bottom: 20px; text-align: center; padding: 15px; background: #f9fafb; border-radius: 12px; border: 1px solid #e5e7eb;">
                <span style="display: block; font-size: 13px; font-weight: 600; color: #6b7280; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px;">Profile Match</span>
                
                {% if match_score > 75 %}
                    <div style="font-size: 2.5rem; font-weight: 800; color: #059669; line-height: 1;">{{ match_score }}%</div>
                    <div style="font-size: 0.9rem; font-weight: 600; color: #059669; margin-top: 5px;">Excellent Match! üöÄ</div>
                {% elif match_score > 40 %}
                    <div style="font-size: 2.5rem; font-weight: 800; color: #d97706; line-height: 1;">{{ match_score }}%</div>
                    <div style="font-size: 0.9rem; font-weight: 600; color: #d97706; margin-top: 5px;">Good Match üëç</div>
                {% else %}
                    <div style="font-size: 2.5rem; font-weight: 800; color: #dc2626; line-height: 1;">{{ match_score }}%</div>
                    <div style="font-size: 0.9rem; font-weight: 600; color: #dc2626; margin-top: 5px;">Low Compatibility ‚ö†Ô∏è</div>
                {% endif %}
            </div>
            <div class="salary-box">
                <div class="salary-amount">‚Çπ{{ job.salary_min }} - ‚Çπ{{ job.salary_max }}</div>
                <div class="salary-period">Yearly Salary</div>
            </div>

            {% if has_applied %}
                <button type="button" class="btn-apply" disabled style="background:#059669; cursor:default;">
                    ‚úì Applied Successfully
                </button>
            {% else %}
                <button type="button" onclick="openModal()" class="btn-apply">
                    Apply Now
                </button>
            {% endif %}

            <form method="POST" style="margin-top:10px;">
                {% csrf_token %}
                <button type="submit" name="save" class="btn-save {% if is_saved %}saved{% endif %}">
                    {% if is_saved %}
                        ‚òÖ Saved
                    {% else %}
                        ‚òÜ Save for later
                    {% endif %}
                </button>
            </form>

            <div style="margin-top: 15px; font-size: 0.9rem; color: #6b7280; cursor: pointer; text-align: center;" id="shareBtn">
                üîó Copy Job Link
            </div>
        </div>
        <div class="card">
            <h3 style="margin-top: 0; font-size: 1.1rem;">Similar Jobs</h3>
            
            {% for sim_job in similar_jobs %}
            <div class="similar-job-item">
                <div class="similar-logo" style="overflow: hidden; display: flex; align-items: center; justify-content: center;">
                    <a href="{% url 'company_profile' sim_job.company.id %}" style="text-decoration: none; color: inherit; display: block; width: 100%; height: 100%;">
                        {% if sim_job.company.logo %}
                            <img src="{{ sim_job.company.logo.url }}" alt="{{ sim_job.company.company_name }}" style="width: 100%; height: 100%; object-fit: cover;">
                        {% else %}
                            <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #f3f4f6; color: #374151; font-weight: bold;">
                                {{ sim_job.company.company_name|slice:":1" }}
                            </div>
                        {% endif %}
                    </a>
                </div>

                <div class="similar-info">
                    <h4>{{ sim_job.title }}</h4>
                    <p>
                        <a href="{% url 'company_profile' sim_job.company.id %}" style="text-decoration: none; color: #6b7280;">
                            {{ sim_job.company.company_name }}
                        </a>
                    </p>
                    <a href="{% url 'job_detail' sim_job.id %}" class="link-view">View Job ‚Üí</a>
                </div>
            </div>
            {% empty %}
                <p style="color:#999; font-size:0.9rem;">No similar jobs found.</p>
            {% endfor %}
        </div>

    </div>
</div>

<div id="applyModal" class="modal-overlay">
    <div class="modal-box">
        
        <div class="modal-header">
            <div class="modal-title">Apply to {{ job.company.company_name }}</div>
            <button class="close-btn" onclick="closeModal()">√ó</button>
        </div>

        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="step active">
                <h3 style="margin-top:0;">Contact Info</h3>
                <div style="display:flex; align-items:center; gap:15px; margin-bottom:20px;">
                    <img src="{% static 'images/avatar_placeholder.png' %}" style="width:50px; height:50px; border-radius:50%;">
                    <div>
                        <div style="font-weight:700;">{{ user.first_name }} {{ user.last_name }}</div>
                        <div style="color:#6b7280; font-size:0.9rem;">Wait, is this you?</div>
                    </div>
                </div>

                <label class="form-label">Email address *</label>
                <input type="email" name="email" class="form-input-modal" value="{{ user.email }}" required>

                <label class="form-label">Mobile phone number *</label>
                <input type="text" name="phone" class="form-input-modal" value="87993 48039">
            </div>

            <div class="step">
                <h3 style="margin-top:0;">Resume</h3>
                <p class="form-note">Be sure to include an updated resume *</p>

                <div class="file-upload-box" onclick="document.getElementById('resumeInput').click()">
                    <div style="font-size:2rem; margin-bottom:10px;">üìÑ</div>
                    <div style="font-weight:600; color:#4f46e5;">Upload resume</div>
                    <div style="font-size:0.85rem; color:#6b7280;">DOC, DOCX, PDF (Max 2 MB)</div>
                </div>
                <input type="file" name="resume" id="resumeInput" style="display:none;" onchange="showFileName()" required>
                <div id="fileNameDisplay" style="margin-top:10px; font-weight:600; font-size:0.9rem;"></div>
            </div>

            <div class="step">
                <h3 style="margin-top:0;">Additional Questions</h3>
                
                <label class="form-label">Are you comfortable commuting to this job's location? *</label>
                <div>
                    <label style="display:flex; gap:8px; align-items:center; margin-bottom:5px;">
                        <input type="radio" name="q1" value="Yes" checked> Yes
                    </label>
                    <label style="display:flex; gap:8px; align-items:center;">
                        <input type="radio" name="q1" value="No"> No
                    </label>
                </div>

                <label class="form-label">How many years of relevant experience do you have? *</label>
                <input type="number" name="q2" class="form-input-modal" placeholder="Ex: 3">
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-back" id="prevBtn" onclick="changeStep(-1)" style="display:none;">Back</button>
                <button type="button" class="btn-next" id="nextBtn" onclick="changeStep(1)">Next</button>
                <button type="submit" class="btn-next" id="submitBtn" style="display:none;">Submit Application</button>
            </div>
        </form>

    </div>
</div>

<script>
    // --- SHARE BUTTON ---
    const shareBtn = document.getElementById('shareBtn');
    if (shareBtn) {
        shareBtn.addEventListener('click', function() {
            navigator.clipboard.writeText(window.location.href).then(() => {
                const originalText = shareBtn.innerHTML;
                shareBtn.innerHTML = "‚úì Copied!";
                shareBtn.style.color = "#059669";
                setTimeout(() => { shareBtn.innerHTML = originalText; shareBtn.style.color = ""; }, 2000);
            });
        });
    }

    // --- MODAL LOGIC ---
    let currentStep = 0;
    const steps = document.querySelectorAll('.step');
    const progressBar = document.getElementById('progressBar');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');

    function openModal() { document.getElementById('applyModal').style.display = 'flex'; }
    function closeModal() { document.getElementById('applyModal').style.display = 'none'; }

    function changeStep(n) {
        steps[currentStep].classList.remove('active');
        currentStep += n;
        steps[currentStep].classList.add('active');
        updateUI();
    }

    function updateUI() {
        let progress = ((currentStep + 1) / steps.length) * 100;
        progressBar.style.width = progress + '%';

        prevBtn.style.display = (currentStep === 0) ? 'none' : 'block';

        if (currentStep === steps.length - 1) {
            nextBtn.style.display = 'none';
            submitBtn.style.display = 'block';
        } else {
            nextBtn.style.display = 'block';
            submitBtn.style.display = 'none';
        }
    }

    function showFileName() {
        const input = document.getElementById('resumeInput');
        const display = document.getElementById('fileNameDisplay');
        if (input.files.length > 0) {
            display.textContent = "Selected: " + input.files[0].name;
            display.style.color = "#059669";
        }
    }
</script>

{% endblock %}